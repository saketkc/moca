language: python

env:
    #- "2.6"
  - "2.7"

cache:
  directories:
    - $HOME/miniconda

before_install:
    #- sudo apt-get update -qq
    #- sudo apt-get install -qq 
 - sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
 - sudo apt-get update
 - sudo apt-get install g++-4.8 gcc-4.8 build-essential
 - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.8 90
 - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8 90
 - sudo apt-get install libstdc++-4.8-dev ghostscript
 - export MINICONDA=$HOME/miniconda 
 - export PATH="$MINICONDA/bin:$PATH"
 - hash -r
 - command -v conda >/dev/null || { wget http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh;
   bash miniconda.sh -b -f -p $MINICONDA; }
 - conda config --set always_yes yes
 - conda update conda
 - conda info -a
 - conda install python=$TRAVIS_PYTHON_VERSION
 - conda remove --name moca-test --all
 - conda config --add channels bioconda
 - conda config --add channels r
 - conda config --add channels saketkc
 - conda install gcc perl
   #- conda create -q -n moca-test python=$TRAVIS_PYTHON_VERSION
 - conda env create -f conda-env.yml -q -n moca-test

 - source activate moca-test
 - export MEME_ETC_DIR="$MINICONDA/envs/moca-test/etc"
 - conda install meme -c saketkc
 - conda install  --file conda-requirements.txt
 - travis_retry pip install codecov nose2[coverage-plugin] coveralls

install:
  - python setup.py install --single-version-externally-managed --record=/tmp/record.txt

after_success:
  - source deactivate moca-test
  - conda remove --name moca-test --all
  - codecov
  - coveralls

after_failure:
  - source deactivate moca-test
  - conda remove --name moca-test --all


script: nose2 -v --with-coverage

deploy:
  provider: pypi
  distributions: sdist bdist_wheel
  user: saketkc
  password:
    secure: PLEASE_REPLACE_ME
  on:
    tags: true
    repo: saketkc/moca
    condition: $TOXENV == py27
